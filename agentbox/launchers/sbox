#!/usr/bin/env bash
# sbox - Launch agentbox containers with Slurm/Pyxis
#
# Usage: sbox [OPTIONS] [-- SLURM_ARGS...]
#
# shellcheck shell=bash

set -euo pipefail

#######################################
# Determine script location and load libraries
#######################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Support both installed (~/.agentbox) and development (repo) layouts
if [[ -f "${SCRIPT_DIR}/../lib/core.sh" ]]; then
    AGENTBOX_LIB="${SCRIPT_DIR}/../lib"
else
    AGENTBOX_LIB="${HOME}/.agentbox/lib"
fi

# Source libraries
source "${AGENTBOX_LIB}/core.sh"
source "${AGENTBOX_LIB}/mounts.sh"
source "${AGENTBOX_LIB}/env.sh"
source "${AGENTBOX_LIB}/launcher.sh"
source "${AGENTBOX_LIB}/slurm.sh"

#######################################
# Usage
#######################################
usage() {
    cat <<EOF
Usage: sbox [OPTIONS] [-- SLURM_ARGS...]

Launch an agentbox container using Slurm with Pyxis.

OPTIONS:
  -p, --proj PATH       Project directory (default: current directory)
  -w, --worktree        Create a git worktree for parallel development
      --branch NAME     Branch name for worktree (default: agent/<id>)
  -t, --tools PATH      Additional tooling repo to mount (repeatable)
  -v, --volume SPEC     Additional volume mount (repeatable)
                        Formats: /path, /path:ro, /src:/dst, /src:/dst:ro
  -m, --mode MODE       Agent mode: patch, yolo, lockdown (default: patch)
  -n, --name NAME       Container name (enables reattachment)
      --image IMAGE     Container image (overrides config default)
      --cmd COMMAND     Command to run in container (default: bash)
  -h, --help            Show this help message
      --debug           Enable debug logging

MODES:
  patch     Agents cannot commit (.git read-only). DEFAULT.
  yolo      Agents can commit locally (but never push).
  lockdown  Use secure image (git binary removed).

SLURM_ARGS:
  Arguments after -- are passed directly to 'srun'.
  Common options: --gpus N, --mem SIZE, --time HH:MM:SS, --partition NAME

EXAMPLES:
  sbox                                    # Current directory, patch mode
  sbox --yolo -p ~/projects/myapp -n dev  # Yolo mode, named container
  sbox -p ~/proj -- --gpus 4 --mem 64G    # With Slurm resources
  sbox attach mydev                       # Reattach to container
  sbox -w -p ~/projects/myapp             # Create worktree
  sbox -v /data/datasets -p ~/proj        # Mount datasets directory

REATTACHMENT:
  sbox attach NAME [-- SLURM_ARGS...]

EOF
}

#######################################
# Slurm-specific variables
#######################################
NAME=""
ATTACH_MODE=0

#######################################
# Parse arguments
#######################################
parse_args() {
    # Check for attach subcommand first
    if [[ "${1:-}" == "attach" ]]; then
        ATTACH_MODE=1
        shift
        if [[ $# -lt 1 ]]; then
            die_usage "attach requires a container name"
        fi
        NAME="$1"
        shift
        # Rest goes to backend args (skip --)
        if [[ "${1:-}" == "--" ]]; then
            shift
        fi
        BACKEND_EXTRA_ARGS=("$@")
        return
    fi

    # First pass: extract slurm-specific args
    local -a args_for_common=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--name)
                NAME="$2"
                shift 2
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                args_for_common+=("$1")
                shift
                ;;
        esac
    done

    # Parse common args
    parse_common_args "${args_for_common[@]}"

    # Handle remaining args (positional project path)
    for arg in "${LAUNCHER_REMAINING_ARGS[@]}"; do
        if [[ "$arg" == -* ]]; then
            die_usage "Unknown option: $arg"
        elif [[ -z "$PROJ" ]]; then
            PROJ="$arg"
        else
            die_usage "Unexpected argument: $arg"
        fi
    done
}

#######################################
# Main
#######################################
main() {
    parse_args "$@"

    # Handle attach mode early
    if [[ $ATTACH_MODE -eq 1 ]]; then
        slurm_validate
        slurm_attach "$NAME" "${BACKEND_EXTRA_ARGS[@]}"
        exit 0
    fi

    # Common setup (config, defaults, image selection)
    launcher_setup "bash"  # Default command for slurm

    # Slurm-specific validation
    slurm_validate

    # Common preparation (worktree, logging)
    launcher_prepare

    # Log container name if set
    if [[ -n "$NAME" ]]; then
        log_info "Container name: $NAME"
    fi

    # Build mounts and environment
    launcher_build

    # Build slurm args with config defaults
    declare -a slurm_args=()

    # Check if user provided these in BACKEND_EXTRA_ARGS
    has_arg() {
        local needle="$1"
        for arg in "${BACKEND_EXTRA_ARGS[@]}"; do
            if [[ "$arg" == "$needle"* ]]; then
                return 0
            fi
        done
        return 1
    }

    # Apply config defaults only if not specified
    if [[ -n "${AGENTBOX_SLURM_PARTITION:-}" ]] && ! has_arg "--partition"; then
        slurm_args+=(--partition "${AGENTBOX_SLURM_PARTITION}")
    fi

    if [[ -n "${AGENTBOX_SLURM_GPUS:-}" ]] && ! has_arg "--gpus"; then
        slurm_args+=(--gpus "${AGENTBOX_SLURM_GPUS}")
    fi

    if [[ -n "${AGENTBOX_SLURM_MEM:-}" ]] && ! has_arg "--mem"; then
        slurm_args+=(--mem "${AGENTBOX_SLURM_MEM}")
    fi

    if [[ -n "${AGENTBOX_SLURM_TIME:-}" ]] && ! has_arg "--time"; then
        slurm_args+=(--time "${AGENTBOX_SLURM_TIME}")
    fi

    # Add user-provided args
    slurm_args+=("${BACKEND_EXTRA_ARGS[@]}")

    # Execute
    slurm_run "$IMAGE" "$PROJ" "$NAME" "$CMD" "${slurm_args[@]}"
}

main "$@"
