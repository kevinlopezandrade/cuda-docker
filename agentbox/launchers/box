#!/usr/bin/env bash
# box - Launch agentbox containers with Docker
#
# Usage: box [OPTIONS] [-- DOCKER_ARGS...]
#
# shellcheck shell=bash

set -euo pipefail

#######################################
# Determine script location and load libraries
#######################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Support both installed (~/.agentbox) and development (repo) layouts
if [[ -f "${SCRIPT_DIR}/../lib/core.sh" ]]; then
    AGENTBOX_LIB="${SCRIPT_DIR}/../lib"
else
    AGENTBOX_LIB="${HOME}/.agentbox/lib"
fi

# Source libraries
source "${AGENTBOX_LIB}/core.sh"
source "${AGENTBOX_LIB}/mounts.sh"
source "${AGENTBOX_LIB}/env.sh"
source "${AGENTBOX_LIB}/launcher.sh"
source "${AGENTBOX_LIB}/docker.sh"

#######################################
# Usage
#######################################
usage() {
    cat <<EOF
Usage: box [OPTIONS] [-- DOCKER_ARGS...]

Launch an agentbox container using Docker.

OPTIONS:
  -p, --proj PATH       Project directory (default: current directory)
  -w, --worktree        Create a git worktree for parallel development
      --branch NAME     Branch name for worktree (default: agent/<id>)
  -f, --from REF        Start worktree from REF (branch, tag, or commit)
  -n, --name NAME       Container name (for easier identification/reattachment)
  -k, --keep            Keep container running after shell exit
  -t, --tools PATH      Additional tooling repo to mount (repeatable)
  -v, --volume SPEC     Additional volume mount (repeatable)
                        Formats: /path, /path:ro, /src:/dst, /src:/dst:ro
  -P, --port PORT       Publish container port to host (repeatable)
                        Formats: 8888, 8888:8888, 127.0.0.1:8888:8888
  -m, --mode MODE       Agent mode: patch, yolo, lockdown (default: patch)
      --image IMAGE     Container image (overrides config default)
      --gpus SPEC       GPU specification (default: all, use "none" to disable)
      --cmd COMMAND     Command to run in container (default: interactive shell)
  -h, --help            Show this help message
      --debug           Enable debug logging

SUBCOMMANDS:
  ps                    List running agentbox containers
  exec PATTERN          Exec into container matching pattern (branch/project/name)

MODES:
  patch     Agents cannot commit (.git read-only). DEFAULT.
  yolo      Agents can commit locally (but never push).
  lockdown  Use secure image (git binary removed).

DOCKER_ARGS:
  Arguments after -- are passed directly to 'docker run'.
  Example: box -- --memory 16g --cpus 4

EXAMPLES:
  box                                    # Current directory, patch mode
  box --yolo -p ~/projects/myapp         # Yolo mode
  box -p ~/projects/myapp --gpus none    # Disable GPUs
  box -- --memory 32g --shm-size 16g     # Extra docker args
  box -w -p ~/projects/myapp             # Create worktree
  box -w --branch feature/auth -p ~/proj # Worktree with branch
  box -w -f main -p ~/projects/myapp     # Worktree starting from main
  box -v /data/datasets                  # Mount datasets directory
  box -v /data:/data:ro -v /models       # Multiple volume mounts
  box -k -p ~/projects/myapp             # Keep container running after exit
  box -P 8888 -p ~/projects/myapp        # Jupyter/Marimo on port 8888
  box -P 8888 -P 3000 -p ~/projects/myapp # Multiple ports

EOF
}

#######################################
# Subcommands
#######################################

# List running agentbox containers with metadata
box_ps() {
    require_command docker "Please install Docker."

    # Header
    printf "%-28s %-10s %-24s %s\n" "NAME" "STATUS" "BRANCH" "PROJECT"
    printf "%-28s %-10s %-24s %s\n" "----" "------" "------" "-------"

    # List containers with agentbox labels (running and stopped)
    docker ps -a --filter "label=com.agentbox.workdir" \
        --format '{{.Names}}\t{{.State}}\t{{.Label "com.agentbox.branch"}}\t{{.Label "com.agentbox.project"}}' |
    while IFS=$'\t' read -r name state branch project; do
        branch="${branch:--}"
        project="${project:--}"
        printf "%-28s %-10s %-24s %s\n" "$name" "$state" "$branch" "$project"
    done
}

# Exec into container matching pattern
box_exec() {
    local pattern="${1:-}"
    local exec_user="${2:-}"

    require_command docker "Please install Docker."

    if [[ -z "$pattern" ]]; then
        # No pattern: show interactive list
        echo "Running agentbox containers:"
        echo ""
        box_ps
        echo ""
        echo "Usage: box exec <pattern> [--root]"
        echo "  Pattern matches container name, branch, or project"
        exit 1
    fi

    # Find matching containers (running only for exec)
    local -a matches=()
    local -a match_info=()

    while IFS=$'\t' read -r name branch project; do
        # Match against name, branch, or project
        if [[ "$name" == *"$pattern"* ]] || \
           [[ "$branch" == *"$pattern"* ]] || \
           [[ "$project" == *"$pattern"* ]]; then
            matches+=("$name")
            match_info+=("$name ($branch, $project)")
        fi
    done < <(docker ps --filter "label=com.agentbox.workdir" \
        --format '{{.Names}}\t{{.Label "com.agentbox.branch"}}\t{{.Label "com.agentbox.project"}}')

    if [[ ${#matches[@]} -eq 0 ]]; then
        echo "No running containers match '$pattern'"
        echo ""
        echo "Running containers:"
        box_ps
        exit 1
    elif [[ ${#matches[@]} -eq 1 ]]; then
        local container="${matches[0]}"
        echo "Attaching to: ${match_info[0]}"

        local -a exec_args=(-it)
        if [[ "$exec_user" == "--root" ]]; then
            exec_args+=(-u root)
        fi

        exec docker exec "${exec_args[@]}" "$container" bash -l
    else
        echo "Multiple containers match '$pattern':"
        echo ""
        for info in "${match_info[@]}"; do
            echo "  $info"
        done
        echo ""
        echo "Be more specific or use the full container name."
        exit 1
    fi
}

#######################################
# Docker-specific variables
#######################################
GPUS=""
NAME=""
declare -a PORTS=()

#######################################
# Parse arguments
#######################################
parse_args() {
    # Check for subcommands first
    case "${1:-}" in
        ps)
            box_ps
            exit 0
            ;;
        exec)
            shift
            box_exec "$@"
            exit 0
            ;;
    esac

    # First pass: extract docker-specific args
    local -a args_for_common=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --gpus)
                GPUS="$2"
                shift 2
                ;;
            -n|--name)
                NAME="$2"
                shift 2
                ;;
            -P|--port)
                PORTS+=("$2")
                shift 2
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                args_for_common+=("$1")
                shift
                ;;
        esac
    done

    # Parse common args
    parse_common_args "${args_for_common[@]}"

    # Handle remaining args (positional project path)
    for arg in "${LAUNCHER_REMAINING_ARGS[@]}"; do
        if [[ "$arg" == -* ]]; then
            die_usage "Unknown option: $arg"
        elif [[ -z "$PROJ" ]]; then
            PROJ="$arg"
        else
            die_usage "Unexpected argument: $arg"
        fi
    done
}

#######################################
# Main
#######################################
main() {
    parse_args "$@"

    # Common setup (config, defaults, image selection)
    launcher_setup

    # Docker-specific validation
    docker_validate

    # Common preparation (worktree, logging)
    launcher_prepare

    # Build mounts and environment
    launcher_build

    # Build docker args
    declare -a docker_args=()

    # GPUs - enabled by default
    if [[ "$GPUS" == "none" ]]; then
        : # Explicitly disabled
    elif [[ -n "$GPUS" ]]; then
        docker_args+=(--gpus "$GPUS")
    elif [[ -n "${AGENTBOX_DOCKER_GPUS:-}" ]]; then
        docker_args+=(--gpus "${AGENTBOX_DOCKER_GPUS}")
    else
        docker_args+=(--gpus all)
    fi

    # Ports
    for port in "${PORTS[@]}"; do
        # If just a port number, map to same port on host (e.g., 2718 -> 2718:2718)
        if [[ "$port" =~ ^[0-9]+$ ]]; then
            docker_args+=(-p "$port:$port")
        else
            docker_args+=(-p "$port")
        fi
        log_info "Port forwarding: $port"
    done

    # User-provided extra args
    docker_args+=("${BACKEND_EXTRA_ARGS[@]}")

    # Execute
    docker_run "$IMAGE" "$PROJ" "$CMD" "$KEEP_ALIVE" "$NAME" "${docker_args[@]}"
}

main "$@"
